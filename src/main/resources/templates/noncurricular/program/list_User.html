<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ì¡°íšŒ (í•™ìƒ)</title>
    <style>
        :root{
          /* Light theme tokens */
          --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --chip:#f3f4f6; --card:#fafafa;
          --pri:#2563eb; --pri-600:#1d4ed8; --pri-50:#eef2ff;
          --ok:#16a34a; --warn:#d97706; --err:#dc2626;
          --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif}
        a{color:inherit;text-decoration:none}
        .wrap{max-width:1180px;margin:32px auto;padding:0 16px}

        /* Header */
        .title-bar{display:flex;gap:12px;align-items:center;margin-bottom:18px}
        .title-bar h1{font-size:20px;margin:0}
        .badge{padding:2px 8px;border-radius:999px;background:var(--pri-50);color:var(--pri-600);font-weight:600}

        /* Search Card */
        .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
        .grid{display:grid;gap:12px}
        .grid.cols-3{grid-template-columns:repeat(3,1fr)}
        .grid.cols-4{grid-template-columns:repeat(4,1fr)}
        .row{display:flex;gap:10px;align-items:center}

        label{display:block;font-weight:600;font-size:12px;color:var(--muted);margin-bottom:6px}
        input[type="text"], input[type="date"], select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
        input::placeholder{color:#9ca3af}

        .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
        .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
        .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
        .btn.primary:hover{background:var(--pri-600)}
        .btn.ghost{background:transparent}

        /* List */
        .list-head{display:flex;justify-content:space-between;align-items:center;margin:16px 4px}
        .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}

        .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
        .prog-card {
          display: flex;
          flex-direction: column;
          background: #fff;
          border: 1px solid var(--line);
          border-radius: var(--radius);
          overflow: hidden;
          transition: transform .15s ease, box-shadow .15s ease;
        }
        .prog-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 4px 10px rgba(0,0,0,.05);
        }

        .prog-card .thumb {
          position: relative;
          width: 100%;
          aspect-ratio: 16 / 9;
          overflow: hidden;
          background: #f3f4f6;
        }
        .prog-card .thumb img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .prog-card .thumb .status {
          position: absolute;
          top: 10px;
          right: 10px;
        }
        .prog-card .body {
          padding: 12px 14px 16px;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        .prog-card h3{margin:0;font-size:16px}
        .meta{display:flex;flex-wrap:wrap;gap:8px;color:var(--muted);font-size:12px}
        .meta .dot::before{content:"â€¢ ";margin:0 4px;color:#c4c4c4}
        .stat{display:flex;gap:8px;align-items:center}
        .stat b{font-weight:700}
        .row.end{justify-content:flex-end}

        .status{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;}
        .status.open{background:#eaf7ef;color:var(--ok);border:1px solid #b9e6c5}
        .status.closed{background:#f3f4f6;color:#6b7280;border:1px solid var(--line)}
        .status.done{background:#eef2ff;color:#4338ca;border:1px solid #c7d2fe}

        /* Pagination */
        .paging{display:flex;gap:6px;justify-content:center;margin:20px 0}
        .page-btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
        .page-btn[aria-current="true"]{background:var(--pri-50);border-color:var(--pri);}

        /* Skeleton */
        .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sk 1.2s infinite}
        @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

        /* Empty & Error */
        .empty{padding:40px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted)}
        .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:10px;opacity:.95}

        /* Responsive */
        @media (max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:640px){.grid.cols-4,.grid.cols-3{grid-template-columns:1fr}.cards{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="wrap">
    <div class="title-bar">
        <span class="badge">í•™ìƒ</span>
        <h1>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ì¡°íšŒ</h1>
        <span id="resultCount" class="chip" aria-live="polite"></span>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <form id="searchForm" class="card" autocomplete="off">
        <div class="grid cols-4">
            <div>
                <label for="q">í”„ë¡œê·¸ë¨ëª…</label>
                <input id="q" name="keyword" type="text" placeholder="ì˜ˆ) ì§„ë¡œìº í”„, ë¦¬ë”ì‹­â€¦" />
            </div>
            <div>
                <label for="category">ë¶„ë¥˜</label>
                <select id="category" name="category">
                    <option value="">ì „ì²´</option>
                    <option value="CAREER">ì§„ë¡œ</option>
                    <option value="COMPETENCY">ì—­ëŸ‰</option>
                    <option value="VOLUNTEER">ë´‰ì‚¬</option>
                    <option value="GLOBAL">ê¸€ë¡œë²Œ</option>
                </select>
            </div>
            <div>
                <label for="dept">ìš´ì˜ë¶€ì„œ</label>
                <select id="dept" name="dept">
                    <option value="">ì „ì²´</option>
                    <option value="NCC">ë¹„êµê³¼ì„¼í„°</option>
                    <option value="JOB">ì·¨ì—…ì§€ì›ì„¼í„°</option>
                    <option value="INTL">êµ­ì œêµë¥˜ì²˜</option>
                </select>
            </div>
            <div>
                <label for="status">ëª¨ì§‘ìƒíƒœ</label>
                <select id="status" name="status">
                    <option value="">ì „ì²´</option>
                    <option value="OPEN">ëª¨ì§‘ì¤‘</option>
                    <option value="CLOSED">ë§ˆê°</option>
                    <option value="DONE">ì¢…ë£Œ</option>
                </select>
            </div>
        </div>
        <div class="grid cols-3" style="margin-top:12px">
            <div>
                <label for="from">ëª¨ì§‘ ì‹œì‘ì¼</label>
                <input id="from" name="from" type="date" />
            </div>
            <div>
                <label for="to">ëª¨ì§‘ ì¢…ë£Œì¼</label>
                <input id="to" name="to" type="date" />
            </div>
            <div class="actions" style="align-self:end">
                <button type="button" class="btn" id="resetBtn">ì´ˆê¸°í™”</button>
                <button type="submit" class="btn primary" aria-label="ê²€ìƒ‰í•˜ê¸°">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg> ê²€ìƒ‰
                </button>
            </div>
        </div>
    </form>

    <div class="list-head">
        <div class="chip">ê²€ìƒ‰ ê²°ê³¼</div>
        <div class="row">
            <a class="btn ghost" href="/student/programs/my-applications">ë‚˜ì˜ ì‹ ì²­ë‚´ì—­ ë³´ê¸°</a>
        </div>
    </div>

    <!-- ëª©ë¡ ì˜ì—­ -->
    <section id="list" class="cards" aria-live="polite" aria-busy="false"></section>
    <nav id="paging" class="paging" aria-label="í˜ì´ì§€ë„¤ì´ì…˜"></nav>
</div>

<div id="toast" class="toast" hidden></div>

<script>
    // =============================
    // Config
    // =============================
    const API = {
      list: '/student/programs/list',
      detail: id => `/student/programs/${id}`,
      apply: id => `/student/programs/${id}/apply`
    };

    // Toggle to use mock data when backend is not ready
    const USE_MOCK = true;

    // =============================
    // State
    // =============================
    const state = {
      page: 0,
      size: 9,
      totalPages: 0,
      totalElements: 0,
      lastQuery: ''
    };

    // =============================
    // Utilities
    // =============================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toast(msg){
      const t = $('#toast');
      t.textContent = msg; t.hidden = false;
      setTimeout(()=> t.hidden = true, 2200);
    }

    function queryFromForm(){
      const f = new FormData($('#searchForm'));
      const p = new URLSearchParams();
      for(const [k,v] of f.entries()) if(v) p.set(k, v.trim());
      p.set('page', state.page);
      p.set('size', state.size);
      return p.toString();
    }

    function statusBadge(s){
      if(s==='OPEN') return '<span class="status open">ëª¨ì§‘ì¤‘</span>';
      if(s==='CLOSED') return '<span class="status closed">ë§ˆê°</span>';
      if(s==='DONE') return '<span class="status done">ì¢…ë£Œ</span>';
      return '';
    }

    // =============================
    // Rendering
    // =============================
    function setBusy(b){ $('#list').setAttribute('aria-busy', String(b)); }

    function renderSkeleton(){
      const host = $('#list');
      host.innerHTML = Array.from({length: state.size}).map(()=>
        `<article class="prog-card">
           <div class="skeleton" style="height:20px;width:70%"></div>
           <div class="skeleton" style="height:14px;width:40%"></div>
           <div class="skeleton" style="height:14px;width:60%"></div>
           <div class="skeleton" style="height:34px;width:100%"></div>
         </article>`).join('');
    }

    function renderList(data){
      const host = $('#list');
      if(!data.content?.length){
        host.innerHTML = `<div class="empty">ì¡°ê±´ì— ë§ëŠ” í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        $('#resultCount').textContent = '0ê±´';
        $('#paging').innerHTML = '';
        return;
      }

      const html = data.content.map(item => {
        const period = `${item.recruitStart} ~ ${item.recruitEnd}`;
        const date = `${item.programStart} ~ ${item.programEnd}`;
        const status = statusBadge(item.status);
        const showApply = item.status === 'OPEN'; // ğŸ‘ˆ ëª¨ì§‘ì¤‘ ì—¬ë¶€

        return `
          <article class="prog-card" aria-label="${item.title}">
            <div class="thumb">
              <img src="${item.thumbnailUrl || 'https://picsum.photos/seed/noncurricular' + item.id + '/600/338'}"
                   alt="${item.title} ì¸ë„¤ì¼" />
              ${status}
            </div>
            <div class="body">
              <div class="row" style="justify-content:space-between;align-items:flex-start">
                <h3><a href="${API.detail(item.id)}">${item.title}</a></h3>
              </div>
              <div class="meta">
                <span>${item.deptName}</span>
                <span class="dot">ëª¨ì§‘ê¸°ê°„ ${period}</span>
                <span class="dot">ìš´ì˜ ${date}</span>
              </div>
              <div class="row" style="justify-content:space-between">
                <div class="stat"><span>ì‹ ì²­</span><b>${item.applied}</b>/<span>${item.capacity}</span></div>
                <div class="row end">
                  <a class="btn" href="${API.detail(item.id)}">ìƒì„¸ë³´ê¸°</a>
                  ${showApply ? `<button class="btn primary" data-apply="${item.id}">ì‹ ì²­í•˜ê¸°</button>` : ''}
                </div>
              </div>
            </div>
          </article>
        `;
      }).join('');

      host.innerHTML = html;
      $('#resultCount').textContent = `${data.totalElements}ê±´`;
      renderPaging(data.number, data.totalPages);

      // ëª¨ì§‘ì¤‘ ì¹´ë“œì—ë§Œ apply ì´ë²¤íŠ¸ ì—°ê²°
      $$('#list [data-apply]').forEach(btn => btn.addEventListener('click', onApply));
    }

    function renderPaging(page, total){
      state.page = page; state.totalPages = total;
      const host = $('#paging');
      if(total <= 1){ host.innerHTML = ''; return; }
      const pages = Array.from({length: total}, (_,i)=>i);
      host.innerHTML = `
        <button class="page-btn" ${page===0?'disabled':''} data-goto="${page-1}">ì´ì „</button>
        ${pages.map(i=>`<button class="page-btn" aria-current="${i===page}" data-goto="${i}">${i+1}</button>`).join('')}
        <button class="page-btn" ${page===total-1?'disabled':''} data-goto="${page+1}">ë‹¤ìŒ</button>
      `;
      host.querySelectorAll('[data-goto]').forEach(b=> b.addEventListener('click', e=>{
        const p = Number(e.currentTarget.getAttribute('data-goto'));
        if(p<0 || p>=state.totalPages) return;
        state.page = p; doSearch();
      }));
    }

    // =============================
    // Data (Mock or Real)
    // =============================
    async function fetchPrograms(query){
      if(!USE_MOCK){
        const res = await fetch(`${API.list}?${query}`);
        if(!res.ok) throw new Error('ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        return await res.json();
      }
      // ---- Mock dataset shaped like backend paging (Page<T>) ----
      const url = new URLSearchParams(query);
      const page = Number(url.get('page')||0);
      const size = Number(url.get('size')||9);
      const keyword = (url.get('keyword')||'').toLowerCase();
      const status = url.get('status')||'';
      const category = url.get('category')||'';
      const dept = url.get('dept')||'';

      const all = Array.from({length:23}).map((_,i)=>({
          id: 200 + i,
          title: ['ì§„ë¡œìº í”„','ë¦¬ë”ì‹­ ì›Œí¬ìˆ','ê¸€ë¡œë²Œ ë©˜í† ë§','ë´‰ì‚¬ ë¦¬ë”','í”„ë ˆì  í…Œì´ì…˜'][i%5] + ' ' + (i+1),
          deptName: ['ë¹„êµê³¼ì„¼í„°','ì·¨ì—…ì§€ì›ì„¼í„°','êµ­ì œêµë¥˜ì²˜'][i%3],
          category: ['CAREER','COMPETENCY','GLOBAL','VOLUNTEER'][i%4],
          recruitStart: '2025-11-01', recruitEnd: '2025-11-30',
          programStart: '2025-12-05', programEnd: '2025-12-06',
          applied: (i*3)%40, capacity: 40,
          status: ['OPEN','CLOSED','DONE'][i%3],
          thumbnailUrl: `https://picsum.photos/seed/noncurricular${i}/600/338`
        }));

      let filtered = all.filter(x =>
        (!keyword || x.title.toLowerCase().includes(keyword)) &&
        (!status || x.status===status) &&
        (!category || x.category===category) &&
        (!dept || (dept==='NCC'?x.deptName==='ë¹„êµê³¼ì„¼í„°':dept==='JOB'?x.deptName==='ì·¨ì—…ì§€ì›ì„¼í„°':dept==='INTL'?x.deptName==='êµ­ì œêµë¥˜ì²˜':true))
      );

      const totalElements = filtered.length;
      const totalPages = Math.max(1, Math.ceil(totalElements/size));
      const start = page*size;
      const content = filtered.slice(start, start+size);
      return { content, totalPages, totalElements, number: page, size };
    }

    // =============================
    // Events
    // =============================
    async function doSearch(){
      try{
        setBusy(true); renderSkeleton();
        const query = queryFromForm();
        state.lastQuery = query;
        const data = await fetchPrograms(query);
        renderList(data);
      }catch(err){
        console.error(err);
        $('#list').innerHTML = `<div class="empty">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
        toast('ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜');
      }finally{ setBusy(false); }
    }

    async function onApply(e){
      const id = e.currentTarget.getAttribute('data-apply');
      if(!id) return;
      if(USE_MOCK){
        toast('ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. (ëª¨ì˜)');
        return;
      }
      try{
        const res = await fetch(API.apply(id), {method:'POST'});
        if(!res.ok) throw new Error('ì‹ ì²­ ì‹¤íŒ¨');
        toast('ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ê°±ì‹ 
        doSearch();
      }catch(err){ toast('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    // Form submit & reset
    $('#searchForm').addEventListener('submit', e=>{ e.preventDefault(); state.page=0; doSearch(); });
    $('#resetBtn').addEventListener('click', ()=>{
      $('#searchForm').reset(); state.page=0; doSearch();
    });

    // First load
    doSearch();
</script>
</body>
</html>
