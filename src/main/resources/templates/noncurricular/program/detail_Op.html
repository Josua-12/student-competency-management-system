<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>비교과 프로그램 상세 (운영자)</title>
    <style>
        :root{
            --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
            --card:#fafafa; --chip:#f3f4f6;
            --pri:#2563eb; --pri-600:#1d4ed8; --pri-50:#eef2ff;
            --ok:#16a34a; --warn:#d97706; --err:#dc2626;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;}
        a{color:inherit;text-decoration:none}
        .wrap{max-width:1160px;margin:20px auto 100px;padding:0 16px}

        .page-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
        .titlebox{display:flex;flex-direction:column;gap:4px}
        .title{font-size:22px;margin:0}
        .sub{color:var(--muted);font-size:13px;margin:0}
        .status{padding:2px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
        .status.draft{background:#f3f4f6;color:#6b7280;border-color:var(--line)}
        .status.pending{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
        .status.approved{background:#ecfeff;color:#155e75;border-color:#bae6fd}
        .status.ongoing{background:#eaf7ef;color:var(--ok);border-color:#b9e6c5}
        .status.completed{background:#eef2ff;color:#4338ca;border-color:#c7d2fe}
        .status.rejected{background:#fee2e2;color:#991b1b;border-color:#fecaca}

        .toolbar{display:flex;flex-wrap:wrap;gap:8px}
        .btn{border-radius:10px;border:1px solid var(--line);padding:9px 14px;background:#fff;cursor:pointer}
        .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
        .btn.warn{background:#fff8f1;border-color:#fed7aa;color:#9a3412}
        .btn.danger{background:#fef2f2;border-color:#fecaca;color:#991b1b}
        .btn.ghost{background:transparent}

        .hero{display:grid;grid-template-columns:2fr 3fr;gap:16px;margin:14px 0 18px}
        .thumb{background:#f3f4f6;border-radius:var(--radius);min-height:260px;overflow:hidden}
        .thumb img{width:100%;height:100%;object-fit:cover;display:block}
        .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px 16px}

        .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px 18px;font-size:13px}
        .info-item{display:flex;flex-direction:column;gap:2px}
        .info-label{color:var(--muted);font-size:11px}
        .info-value{font-weight:500}

        .section{margin-top:16px}
        .section-title{font-size:15px;font-weight:700;margin:0 0 8px;display:flex;align-items:center;gap:6px}
        .small{font-size:11px;color:var(--muted);font-weight:400}

        .chips{display:flex;gap:6px;flex-wrap:wrap}
        .chip{background:var(--chip);border-radius:999px;padding:4px 8px;font-size:11px;color:var(--muted)}

        .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
        .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
        .kpi b{display:block;font-size:18px;margin-top:2px}

        table{width:100%;border-collapse:collapse;font-size:12px}
        th,td{border:1px solid var(--line);padding:6px 8px;text-align:left}
        th{background:#f9fafb;font-weight:600}

        .file-list{list-style:none;margin:0;padding:0}
        .file-list li{display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);background:#fff;border-radius:12px;padding:8px 10px;margin-bottom:6px}
        .file-actions{display:flex;gap:6px}
        .file-actions .btn{padding:6px 8px;font-size:12px}

        .approval{display:grid;grid-template-columns:1fr 2fr 1fr 2fr;gap:8px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-size:12px;margin-bottom:6px}

        .sticky-actions{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.96);border-top:1px solid var(--line);padding:10px 16px;z-index:10}
        .sticky-inner{max-width:1160px;margin:0 auto;display:flex;gap:8px}
        .spacer{flex:1}

        .toast{position:fixed;right:16px;bottom:64px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;font-size:12px;opacity:.96;z-index:20}
        [hidden]{display:none!important}

        @media (max-width:900px){
            .hero{grid-template-columns:1fr}
            .info-grid{grid-template-columns:1fr}
            .kpis{grid-template-columns:repeat(2,1fr)}
            .sticky-actions{position:static;margin-top:14px}
        }
    </style>
</head>
<body>
<div class="wrap">
    <!-- 헤더 -->
    <div class="page-head">
        <div class="titlebox">
            <h1 class="title" id="title">프로그램명</h1>
            <p class="sub" id="codeText">PRG-2025-000123</p>
        </div>
        <div class="toolbar">
            <span id="statusBadge" class="status draft">DRAFT</span>
            <button class="btn" id="btnEdit">수정</button>
            <button class="btn primary" id="btnSave">저장</button>
            <button class="btn warn" id="btnRequest">제출(승인요청)</button>
            <button class="btn danger" id="btnDelete">삭제</button>
            <a class="btn ghost" id="btnList" href="/operator/noncurricular/programs">목록</a>
        </div>
    </div>

    <!-- 히어로: 대표 이미지 + 기본정보 -->
    <section class="hero">
        <div class="thumb"><img id="thumbnail" alt="대표 이미지"></div>
        <aside class="card">
            <div class="info-grid">
                <div class="info-item"><span class="info-label">운영부서</span><span class="info-value" id="deptName">-</span></div>
                <div class="info-item"><span class="info-label">카테고리</span><span class="info-value" id="categoryName">-</span></div>
                <div class="info-item"><span class="info-label">모집기간</span><span class="info-value" id="recruitPeriod">-</span></div>
                <div class="info-item"><span class="info-label">운영기간</span><span class="info-value" id="programPeriod">-</span></div>
                <div class="info-item"><span class="info-label">운영형태</span><span class="info-value" id="runType">-</span></div>
                <div class="info-item"><span class="info-label">장소</span><span class="info-value" id="locationText">-</span></div>
                <div class="info-item"><span class="info-label">비교과 포인트</span><span class="info-value" id="pointsText">-</span></div>
                <div class="info-item"><span class="info-label">담당자</span><span class="info-value" id="ownerText">-</span></div>
            </div>
            <div class="chips" style="margin-top:10px">
                <span class="chip" id="categoryChip"></span>
                <span class="chip" id="deptChip"></span>
            </div>
        </aside>
    </section>

    <!-- KPI / 현황 -->
    <section class="section">
        <h2 class="section-title">모집·운영 현황</h2>
        <div class="kpis">
            <div class="kpi"><span class="small">정원</span><b id="capMax">0</b></div>
            <div class="kpi"><span class="small">최소인원</span><b id="capMin">0</b></div>
            <div class="kpi"><span class="small">신청</span><b id="applied">0</b></div>
            <div class="kpi"><span class="small">승인</span><b id="approved">0</b></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <a class="btn" id="btnApplicants" href="#">신청자 목록</a>
            <a class="btn" id="btnAttendance" href="#">출석 관리</a>
            <a class="btn" id="btnSatisfaction" href="#">만족도 관리</a>
            <a class="btn" id="btnCompletion" href="#">이수 현황</a>
            <a class="btn" id="btnMileage" href="#">포인트 등록</a>
        </div>
    </section>

    <!-- 개요 -->
    <section class="card section">
        <h2 class="section-title">프로그램 개요</h2>
        <p id="summary" style="margin:0 0 6px;color:var(--muted)"></p>
        <p id="description" style="white-space:pre-line;margin:0"></p>
    </section>

    <!-- 일정·회차 -->
    <section class="card section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h2 class="section-title">일정·회차</h2>
            <a class="btn" id="btnManageSchedule" href="#">회차 관리</a>
        </div>
        <table id="scheduleTable">
            <thead><tr><th>회차</th><th>일자</th><th>시간</th><th>장소</th><th>내용</th></tr></thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- 역량·성과 -->
    <section class="card section">
        <h2 class="section-title">연계 역량·성과</h2>
        <div class="chips" id="competencyChips"></div>
        <div style="margin-top:8px">
            <p class="small">이수 기준</p>
            <p id="completionCriteria" style="margin:0"></p>
        </div>
    </section>

    <!-- 파일 -->
    <section class="card section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h2 class="section-title">파일</h2>
            <a class="btn" id="btnFileManage" href="#">파일 관리</a>
        </div>
        <ul id="fileList" class="file-list"></ul>
    </section>

    <!-- 승인 이력 -->
    <section class="card section">
        <h2 class="section-title">승인 이력</h2>
        <div id="approvalList"></div>
    </section>
</div>

<!-- 하단 고정 액션 -->
<div class="sticky-actions">
    <div class="sticky-inner">
        <a href="/operator/noncurricular/programs" class="btn ghost">목록</a>
        <div class="spacer"></div>
        <button class="btn" id="stickyEdit">수정</button>
        <button class="btn primary" id="stickySave">저장</button>
        <button class="btn warn" id="stickyRequest">제출(승인요청)</button>
        <button class="btn danger" id="stickyDelete">삭제</button>
    </div>
</div>

<div id="toast" class="toast" hidden></div>

<script>
    // ---- 설정 ----
    const USE_MOCK_DETAIL = true;

    const API = {
        detail: id => `/operator/noncurricular/programs/${id}`,
        save:   id => `/operator/noncurricular/programs/${id}`,
        request:id => `/operator/noncurricular/programs/${id}/approval`,
        delete: id => `/operator/noncurricular/programs/${id}`,
        applicants: id => `/operator/noncurricular/programs/${id}/applications`,
        attendance: id => `/operator/noncurricular/programs/${id}/attendance`,
        satisfaction: id => `/operator/noncurricular/programs/${id}/satisfaction`,
        completion: id => `/operator/noncurricular/programs/${id}/completion`,
        mileage: id => `/operator/noncurricular/mileage?progId=${id}`,
        schedule: id => `/operator/noncurricular/programs/${id}/schedules`,
        files: id => `/operator/noncurricular/programs/${id}/files`
    };

    // ---- 유틸 ----
    const $ = s => document.querySelector(s);
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.hidden=false; setTimeout(()=>t.hidden=true,1800); }

    function programIdFromPath(){
        const parts = location.pathname.split('/').filter(Boolean);
        return Number(parts[parts.length-1]) || 201;
    }

    function statusClass(s){
        return ({
            DRAFT:'status draft', PENDING:'status pending', APPROVED:'status approved',
            ONGOING:'status ongoing', COMPLETED:'status completed', REJECTED:'status rejected'
        })[s] || 'status';
    }

    // ---- Mock 데이터 ----
    function mockDetail(id){
        return {
            id, code:`PRG-2025-${String(id).padStart(6,'0')}`,
            title:'창의융합 해커톤',
            summary:'기획-개발-디자인 협업 프로젝트로 실전 문제 해결 경험 제공',
            description:'- 오리엔테이션\n- 팀빌딩 & 멘토링\n- 개발 스프린트\n- 최종 발표 및 시상',
            deptName:'SW중심대학사업단', category:'경진대회',
            status:'DRAFT', runType:'OFFLINE', locationText:'공학관 101호',
            recruitStart:'2025-11-01', recruitEnd:'2025-11-10',
            programStart:'2025-11-20', programEnd:'2025-11-22',
            capacityMax:30, capacityMin:10, applied:19, approved:17,
            points:50, ownerName:'홍길동', ownerTel:'02-123-4567', ownerEmail:'hack@univ.ac.kr',
            thumbnailUrl:'https://picsum.photos/seed/scms-operator/980/560',
            schedules:[
                {order:1, date:'2025-11-20', time:'10:00~17:00', place:'공학관 101호', content:'OT & 팀빌딩'},
                {order:2, date:'2025-11-21', time:'09:00~21:00', place:'공학관 101호', content:'개발 스프린트'},
                {order:3, date:'2025-11-22', time:'09:00~18:00', place:'공학관 101호', content:'발표 & 시상'}
            ],
            competencies:['문제해결','협업','의사소통'],
            completionCriteria:'전 회차 참석 + 만족도 제출 + 발표 점수 70점 이상',
            files:[
                {id:1,name:'운영계획서.pdf',size:'1.2MB',date:'2025-10-30',url:'#'},
                {id:2,name:'참가신청서.hwp',size:'180KB',date:'2025-10-30',url:'#'}
            ],
            approvals:[
                {date:'2025-11-05 14:22', status:'PENDING', actor:'부서관리자 홍길동', comment:'검토 예정'},
            ]
        };
    }

    async function fetchDetail(id){
        if(USE_MOCK_DETAIL) return mockDetail(id);
        const res = await fetch(API.detail(id));
        if(!res.ok) throw new Error('상세 조회 실패');
        return res.json();
    }

    // ---- 렌더링 ----
    function render(d){
        // 헤더
        $('#title').textContent = d.title;
        $('#codeText').textContent = d.code || '';
        const badge = $('#statusBadge'); badge.className = statusClass(d.status); badge.textContent = d.status;

        // 이미지 + 기본 정보
        $('#thumbnail').src = d.thumbnailUrl || 'https://picsum.photos/seed/noncurr-default/980/560';
        $('#thumbnail').alt = `${d.title} 대표 이미지`;
        $('#deptName').textContent = d.deptName || '-';
        $('#categoryName').textContent = d.category || '-';
        $('#recruitPeriod').textContent = d.recruitStart && d.recruitEnd ? `${d.recruitStart} ~ ${d.recruitEnd}` : '-';
        $('#programPeriod').textContent = d.programStart && d.programEnd ? `${d.programStart} ~ ${d.programEnd}` : '-';
        $('#runType').textContent = ({OFFLINE:'오프라인',ONLINE:'온라인',MIXED:'온·오프라인 혼합'})[d.runType] || '-';
        $('#locationText').textContent = d.locationText || (d.runType==='ONLINE'?'온라인':'-');
        $('#pointsText').textContent = d.points!=null ? `${d.points}점` : '-';
        $('#ownerText').textContent = [d.ownerName,[d.ownerTel,d.ownerEmail].filter(Boolean).join(' / ')].filter(Boolean).join(' · ');
        $('#categoryChip').textContent = d.category ? `분류: ${d.category}` : '';
        $('#deptChip').textContent = d.deptName ? `부서: ${d.deptName}` : '';

        // KPI
        $('#capMax').textContent = d.capacityMax ?? 0;
        $('#capMin').textContent = d.capacityMin ?? 0;
        $('#applied').textContent = d.applied ?? 0;
        $('#approved').textContent = d.approved ?? 0;

        // 개요
        $('#summary').textContent = d.summary || '';
        $('#description').textContent = d.description || '-';
        $('#completionCriteria').textContent = d.completionCriteria || '-';
        const chips = $('#competencyChips'); chips.innerHTML='';
        (d.competencies||[]).forEach(c=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=c; chips.appendChild(s); });

        // 일정
        const tbody = $('#scheduleTable tbody'); tbody.innerHTML='';
        (d.schedules||[]).forEach(s=>{
            const tr=document.createElement('tr');
            tr.innerHTML = `<td>${s.order??''}</td><td>${s.date??''}</td><td>${s.time??''}</td><td>${s.place??''}</td><td>${s.content??''}</td>`;
            tbody.appendChild(tr);
        });
        if(!d.schedules || d.schedules.length===0){
            tbody.innerHTML = `<tr><td colspan="5">등록된 일정이 없습니다.</td></tr>`;
        }

        // 파일
        const ul = $('#fileList'); ul.innerHTML='';
        (d.files||[]).forEach(f=>{
            const li=document.createElement('li');
            li.innerHTML = `<span>${f.name} <span class="small">· ${f.size} · ${f.date}</span></span>
        <span class="file-actions">
          <a class="btn" href="${f.url}" target="_blank">다운로드</a>
          <button class="btn" data-url="${f.url}" onclick="navigator.clipboard.writeText(this.dataset.url).then(()=>toast('링크 복사'))">링크복사</button>
        </span>`;
            ul.appendChild(li);
        });
        if(!d.files || d.files.length===0){
            const li=document.createElement('li'); li.textContent='등록된 파일이 없습니다.'; li.style.padding='10px'; li.style.border='1px dashed var(--line)'; li.style.borderRadius='12px'; li.style.background='#fff';
            ul.appendChild(li);
        }

        // 승인 이력
        const appr = $('#approvalList'); appr.innerHTML='';
        (d.approvals||[]).forEach(h=>{
            const row=document.createElement('div');
            row.className='approval';
            row.innerHTML = `<div class="small">상신/처리일</div><div>${h.date||''}</div>
                       <div class="small">상태</div><div>${h.status||''}</div>
                       <div class="small">처리자</div><div>${h.actor||''}</div>
                       <div class="small">의견</div><div>${h.comment||''}</div>`;
            appr.appendChild(row);
        });
        if(!d.approvals || d.approvals.length===0){
            const p=document.createElement('p'); p.className='small'; p.textContent='승인 이력이 없습니다.'; appr.appendChild(p);
        }

        // 링크 목적지
        const id = d.id;
        $('#btnApplicants').href = API.applicants(id);
        $('#btnAttendance').href = API.attendance(id);
        $('#btnSatisfaction').href = API.satisfaction(id);
        $('#btnCompletion').href = API.completion(id);
        $('#btnMileage').href = API.mileage(id);
        $('#btnManageSchedule').href = API.schedule(id);
        $('#btnFileManage').href = API.files(id);
    }

    // ---- 액션 바인딩 ----
    function bindActions(id){
        const save = async ()=>{
            if(USE_MOCK_DETAIL){ toast('저장되었습니다. (모의)'); return; }
            const res = await fetch(API.save(id),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({/*payload*/})});
            if(!res.ok) throw new Error(); toast('저장되었습니다.');
        };
        const request = async ()=>{
            if(!confirm('승인요청 하시겠습니까?')) return;
            if(USE_MOCK_DETAIL){ toast('승인요청이 접수되었습니다. (모의)'); $('#statusBadge').className='status pending'; $('#statusBadge').textContent='PENDING'; return; }
            const res = await fetch(API.request(id),{method:'POST'}); if(!res.ok) throw new Error(); toast('승인요청이 접수되었습니다.');
        };
        const remove = async ()=>{
            if(!confirm('삭제 후 복구할 수 없습니다. 삭제하시겠습니까?')) return;
            if(USE_MOCK_DETAIL){ toast('삭제되었습니다. (모의)'); location.href='/operator/noncurricular/programs'; return; }
            const res = await fetch(API.delete(id),{method:'DELETE'}); if(!res.ok) throw new Error(); location.href='/operator/noncurricular/programs';
        };

        // 상단/하단 버튼 동기화
        ['btnSave','stickySave'].forEach(idBtn=>document.getElementById(idBtn).addEventListener('click',()=>save().catch(()=>toast('저장 실패'))));
        ['btnRequest','stickyRequest'].forEach(idBtn=>document.getElementById(idBtn).addEventListener('click',()=>request().catch(()=>toast('요청 실패'))));
        ['btnDelete','stickyDelete'].forEach(idBtn=>document.getElementById(idBtn).addEventListener('click',()=>remove().catch(()=>toast('삭제 실패'))));

        ['btnEdit','stickyEdit'].forEach(idBtn=>document.getElementById(idBtn).addEventListener('click',()=>toast('수정 모드 (폼 바인딩 연결)')));
    }

    // ---- 시작 ----
    (async function init(){
        try{
            const id = programIdFromPath();
            const detail = await fetchDetail(id);
            render(detail);
            bindActions(detail.id);
        }catch(e){
            console.error(e); toast('상세 정보를 불러오지 못했습니다.');
        }
    })();
</script>
</body>
</html>
