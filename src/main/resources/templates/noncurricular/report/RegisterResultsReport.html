<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OP-007 ê²°ê³¼ë³´ê³ ì„œ ë“±ë¡</title>
    <style>
        :root{
            --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
            --pri:#2563eb; --pri-600:#1d4ed8; --pri-50:#eef2ff;
            --ok:#16a34a; --warn:#d97706; --err:#dc2626;
            --chip:#f3f4f6; --card:#fafafa; --focus:#93c5fd;
            --shadow:0 6px 20px rgba(0,0,0,.08);
            --radius:14px;
        }
        html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
        h1{font-size:22px;margin:0 0 12px}
        h2{font-size:16px;margin:0 0 10px}
        .page{max-width:1200px;margin:24px auto;padding:0 16px}
        .toolbar{display:grid;gap:10px;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto auto;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
        .field{display:flex;flex-direction:column;gap:6px}
        label{font-weight:600;color:#374151}
        input[type="text"], input[type="date"], select, textarea{
            border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff;
            outline:none; transition:.15s; font-size:14px;
        }
        input:focus, select:focus, textarea:focus{box-shadow:0 0 0 3px var(--focus); border-color:#93c5fd}
        .btn{border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer}
        .btn.pri{background:var(--pri); border-color:var(--pri); color:#fff}
        .btn.pri:hover{background:var(--pri-600)}
        .btn.ghost{background:transparent}
        .btn.warn{background:var(--warn); border-color:var(--warn); color:#fff}
        .btn.ok{background:var(--ok); border-color:var(--ok); color:#fff}
        .btn.err{background:var(--err); border-color:var(--err); color:#fff}
        .stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

        /* KPI chips */
        .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:14px 0}
        .kpi{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:12px}
        .kpi .name{font-size:12px;color:var(--muted)}
        .kpi .val{font-size:18px;font-weight:700;margin-top:4px}

        /* Card sections */
        .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
        .muted{color:var(--muted)}
        .help{font-size:12px;color:var(--muted)}

        /* Tables */
        table{width:100%;border-collapse:separate;border-spacing:0}
        th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
        th{font-size:12px;color:#374151;background:#f9fafb}
        tr:last-child td{border-bottom:none}

        /* Uploader */
        .uploader{border:2px dashed var(--line);border-radius:14px;padding:14px;text-align:center;background:#fcfcfc}
        .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
        .thumb{position:relative;width:120px;height:90px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#f3f4f6}
        .thumb img{width:100%;height:100%;object-fit:cover}
        .thumb button{position:absolute;top:6px;right:6px;border:none;background:rgba(0,0,0,.55);color:#fff;border-radius:8px;padding:2px 6px;cursor:pointer}

        /* Footer actions */
        .footer{display:flex;gap:10px;justify-content:flex-end;margin:16px 0 40px}

        /* Modal */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
        .modal.open{display:flex}
        .modal .panel{background:#fff;border-radius:16px;box-shadow:var(--shadow);width:min(920px,95vw);max-height:85vh;overflow:auto;border:1px solid var(--line)}
        .modal .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
        .modal .body{padding:16px}
        .icon-btn{width:38px;height:38px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}

        /* Toast */
        .toast-wrap{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
        .toast{background:#111827;color:#fff;border-radius:10px;padding:10px 12px;box-shadow:var(--shadow);opacity:.98}
        .toast.ok{background:var(--ok)} .toast.err{background:var(--err)} .toast.warn{background:var(--warn)}

        /* Responsive */
        @media (max-width: 980px){
            .toolbar{grid-template-columns:1fr 1fr; }
            .kpis{grid-template-columns:repeat(3,1fr)}
            .grid-2,.grid-3{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
<div class="page">
    <h1>ê²°ê³¼ë³´ê³ ì„œ ë“±ë¡ <span class="muted">ìš´ì˜ì</span></h1>

    <!-- Toolbar: Program / Schedule / Period / Search -->
    <div class="toolbar" role="search">
        <div class="field">
            <label for="prog">í”„ë¡œê·¸ë¨</label>
            <div class="stack">
                <input id="prog" type="text" placeholder="í”„ë¡œê·¸ë¨ ID ë˜ëŠ” ëª…" aria-label="í”„ë¡œê·¸ë¨ ì…ë ¥" />
                <button id="btnFindProg" class="icon-btn" title="í”„ë¡œê·¸ë¨ ì°¾ê¸°" aria-label="í”„ë¡œê·¸ë¨ ì°¾ê¸°">ğŸ”</button>
            </div>
            <div class="help">ì˜ˆ: 123 ë˜ëŠ” â€˜ì§„ë¡œìº í”„â€™</div>
        </div>
        <div class="field">
            <label for="schd">íšŒì°¨</label>
            <select id="schd" aria-label="íšŒì°¨ ì„ íƒ"><option value="">íšŒì°¨ ì„ íƒ</option></select>
        </div>
        <div class="field">
            <label for="from">í™œë™ê¸°ê°„ ì‹œì‘</label>
            <input id="from" type="date"/>
        </div>
        <div class="field">
            <label for="to">í™œë™ê¸°ê°„ ì¢…ë£Œ</label>
            <input id="to" type="date"/>
        </div>
        <div class="field">
            <label for="status">ìƒíƒœ</label>
            <select id="status">
                <option value="">ì „ì²´</option>
                <option value="DRAFT">ì„ì‹œì €ì¥</option>
                <option value="SUBMITTED">ì œì¶œ</option>
                <option value="APPROVED">ìŠ¹ì¸ì™„ë£Œ</option>
                <option value="REJECTED">ë°˜ë ¤</option>
            </select>
        </div>
        <div class="field" style="align-self:end;">
            <button id="btnSearch" class="btn pri">ê²€ìƒ‰</button>
        </div>
        <div class="field" style="align-self:end;">
            <button id="btnReset" class="btn">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- KPI -->
    <div class="kpis" aria-live="polite">
        <div class="kpi"><div class="name">ì´ ì‹ ì²­</div><div class="val" id="kpiApply">-</div></div>
        <div class="kpi"><div class="name">ì°¸ì„</div><div class="val" id="kpiAttend">-</div></div>
        <div class="kpi"><div class="name">ì´ìˆ˜</div><div class="val" id="kpiComplete">-</div></div>
        <div class="kpi"><div class="name">ë§Œì¡±ë„ ì œì¶œ</div><div class="val" id="kpiSurvey">-</div></div>
        <div class="kpi"><div class="name">í‰ê·  ë§Œì¡±ë„</div><div class="val" id="kpiRating">-</div></div>
        <div class="kpi"><div class="name">ë§ˆì¼ë¦¬ì§€ í•©ê³„</div><div class="val" id="kpiMileage">-</div></div>
    </div>

    <!-- Program Basic -->
    <div class="card">
        <h2>ê¸°ë³¸ì •ë³´</h2>
        <div class="grid-3">
            <div class="field">
                <label>í”„ë¡œê·¸ë¨ëª…</label>
                <input id="title" type="text" placeholder="ìë™/ìˆ˜ì • ê°€ëŠ¥" />
            </div>
            <div class="field">
                <label>ìš´ì˜ë¶€ì„œ</label>
                <input id="dept" type="text" placeholder="ìë™/ìˆ˜ì • ê°€ëŠ¥" />
            </div>
            <div class="field">
                <label>ìš´ì˜ê¸°ê°„</label>
                <input id="period" type="text" placeholder="ì˜ˆ: 2025-05-01 ~ 2025-05-31" />
            </div>
        </div>
        <div class="grid-2" style="margin-top:10px">
            <div class="field">
                <label>ìš´ì˜ë°©ì‹/ì¥ì†Œ</label>
                <input id="runPlace" type="text" placeholder="ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸, ì¥ì†Œëª… ë“±" />
            </div>
            <div class="field">
                <label>ë‹´ë‹¹ì ì—°ë½ì²˜</label>
                <input id="contact" type="text" placeholder="010-0000-0000 / email@univ.ac.kr" />
            </div>
        </div>
    </div>

    <!-- Report Body -->
    <div class="card" style="margin-top:12px">
        <h2>ë³´ê³ ì„œ ë³¸ë¬¸</h2>
        <div class="grid-2">
            <div class="field">
                <label>í™œë™ ê°œìš”</label>
                <textarea id="overview" rows="5" placeholder="í™œë™ ëª©ì , ëŒ€ìƒ, ë‚´ìš© ìš”ì•½"></textarea>
                <div class="help">ìµœëŒ€ 1,000ì ê¶Œì¥</div>
            </div>
            <div class="field">
                <label>ìš´ì˜ ê²°ê³¼ ìš”ì•½</label>
                <textarea id="resultSummary" rows="5" placeholder="ì°¸ê°€/ì´ìˆ˜ í†µê³„, ì„±ê³¼ ìš”ì•½"></textarea>
            </div>
        </div>

        <div class="grid-2" style="margin-top:10px">
            <div class="field">
                <label>ë§Œì¡±ë„ ìš”ì•½</label>
                <textarea id="satisfaction" rows="5" placeholder="í‰ê· ì ìˆ˜, ì‘ë‹µ ìˆ˜, ì£¼ìš” í”¼ë“œë°±"></textarea>
            </div>
            <div class="field">
                <label>ì„±ê³¼Â·ì—­ëŸ‰ ë§¤í•‘</label>
                <textarea id="competency" rows="5" placeholder="ì„±ê³¼ì§€í‘œ ë‹¬ì„±ë„, ì—­ëŸ‰ì˜ì—­ ë§¤í•‘"></textarea>
            </div>
        </div>

        <div class="grid-2" style="margin-top:10px">
            <div class="field">
                <label>íŠ¹ì´ì‚¬í•­</label>
                <textarea id="issues" rows="4" placeholder="ë¬¸ì œ ë°œìƒ/ë¦¬ìŠ¤í¬/ëŒ€ì‘"></textarea>
            </div>
            <div class="field">
                <label>í–¥í›„ ê°œì„  ë°©ì•ˆ</label>
                <textarea id="improve" rows="4" placeholder="í”„ë¡œì„¸ìŠ¤/ì½˜í…ì¸ /ìš´ì˜ ê°œì„ ì "></textarea>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="card" style="margin-top:12px">
        <h2>ì°¸ê°€/ì´ìˆ˜ í†µê³„</h2>
        <table aria-describedby="statsHelp">
            <thead><tr>
                <th>êµ¬ë¶„</th><th>ì¸ì›</th><th>ë¹„ê³ </th>
            </tr></thead>
            <tbody id="statTbody">
            <tr><td>ì‹ ì²­</td><td><input type="number" id="stApply" value="0" /></td><td></td></tr>
            <tr><td>ì°¸ì„</td><td><input type="number" id="stAttend" value="0" /></td><td></td></tr>
            <tr><td>ì´ìˆ˜</td><td><input type="number" id="stComplete" value="0" /></td><td></td></tr>
            <tr><td>ë¯¸ì´ìˆ˜</td><td><input type="number" id="stFail" value="0" /></td><td></td></tr>
            </tbody>
        </table>
        <div id="statsHelp" class="help">â€» â€˜ê²€ìƒ‰â€™ ì‹œ KPIì—ì„œ ìë™ ì±„ì›€. í•„ìš” ì‹œ í¸ì§‘ í›„ ì €ì¥ ê°€ëŠ¥.</div>
    </div>

    <!-- Budget -->
    <div class="card" style="margin-top:12px">
        <h2>ì˜ˆì‚° ì‚¬ìš© ë‚´ì—­</h2>
        <table>
            <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡(ì›)</th><th>ë©”ëª¨</th><th style="width:70px">ì‚­ì œ</th></tr></thead>
            <tbody id="budgetTbody"></tbody>
        </table>
        <div class="stack" style="margin-top:10px">
            <button id="btnAddBudget" class="btn">+ í•­ëª© ì¶”ê°€</button>
            <div class="help">ì´ì•¡: <b id="budgetSum">0</b> ì›</div>
        </div>
    </div>

    <!-- Files -->
    <div class="card" style="margin-top:12px">
        <h2>ì²¨ë¶€</h2>
        <div class="grid-2">
            <div>
                <div class="field">
                    <label>ì¦ë¹™ íŒŒì¼(ë¬¸ì„œ)</label>
                    <div class="uploader" id="docDrop">
                        <input id="docInput" type="file" multiple hidden />
                        <p>ì—¬ê¸°ë¡œ íŒŒì¼ ë“œë¡­ ë˜ëŠ” <button id="btnDocPick" class="btn">íŒŒì¼ ì„ íƒ</button></p>
                        <div class="help">pdf, xlsx, docx ë“± (ìµœëŒ€ 10ê°œ)</div>
                    </div>
                    <ul id="docList" class="help" style="margin-top:8px"></ul>
                </div>
            </div>
            <div>
                <div class="field">
                    <label>ì‚¬ì§„(ê°¤ëŸ¬ë¦¬)</label>
                    <div class="uploader" id="imgDrop">
                        <input id="imgInput" type="file" accept="image/*" multiple hidden />
                        <p>ì—¬ê¸°ë¡œ ì´ë¯¸ì§€ ë“œë¡­ ë˜ëŠ” <button id="btnImgPick" class="btn">ì´ë¯¸ì§€ ì„ íƒ</button></p>
                        <div class="help">jpg, png (ìµœëŒ€ 12ì¥)</div>
                    </div>
                    <div class="thumbs" id="thumbs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Actions -->
    <div class="footer">
        <button id="btnPreview" class="btn ghost">ë¯¸ë¦¬ë³´ê¸°</button>
        <button id="btnExport" class="btn">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <div style="flex:1"></div>
        <button id="btnDelete" class="btn err">ì‚­ì œ</button>
        <button id="btnSave" class="btn">ì„ì‹œì €ì¥</button>
        <button id="btnSubmit" class="btn ok">ì œì¶œ(ìŠ¹ì¸ìš”ì²­)</button>
    </div>
</div>

<!-- Program Finder Modal -->
<div id="modalProg" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalProgTitle">
    <div class="panel">
        <div class="head">
            <h2 id="modalProgTitle">í”„ë¡œê·¸ë¨ ì°¾ê¸°</h2>
            <button class="icon-btn" id="btnCloseProg" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div class="body">
            <div class="stack">
                <input id="progQuery" type="text" placeholder="í”„ë¡œê·¸ë¨ëª… ê²€ìƒ‰" style="flex:1" />
                <button id="btnProgSearch" class="btn pri">ê²€ìƒ‰</button>
            </div>
            <table style="margin-top:12px">
                <thead><tr><th>ID</th><th>í”„ë¡œê·¸ë¨ëª…</th><th>ë¶€ì„œ</th><th>ê¸°ê°„</th><th>ì„ íƒ</th></tr></thead>
                <tbody id="progTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="modalPreview" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPreviewTitle">
    <div class="panel">
        <div class="head">
            <h2 id="modalPreviewTitle">ë¯¸ë¦¬ë³´ê¸°</h2>
            <button class="icon-btn" id="btnClosePreview" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div class="body" id="previewBody"></div>
    </div>
</div>

<!-- Toast -->
<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<script>
    /* ===== Config & State ===== */
    const API = {
        base: '', // ì„œë²„ ë£¨íŠ¸. ë°°í¬ ì‹œ e.g. '/api'
        form:   (p,s)=> `/ops/reports/form?progId=${p||''}&schdId=${s||''}`,
        stats:  (p,s)=> `/ops/reports/stats?progId=${p||''}&schdId=${s||''}`,
        save:   `/ops/reports`,
        submit: `/ops/reports/submit`,
        upload: r => `/ops/reports/${r}/files`,
        export: (p,s)=> `/ops/reports/export?progId=${p||''}&schdId=${s||''}`
    };

    const state = {
        programId: null,
        scheduleId: null,
        reportId: null,
        docs: [], // {name,size,file}
        images: [] // {url,file}
    };

    /* ===== Dummy Data (fallback without server) ===== */
    const DUMMY = {
        programs: [
            {id:123, title:'ì§„ë¡œìº í”„', deptName:'ë¹„êµê³¼ì„¼í„°', period:'2025-05-01 ~ 2025-05-31',
                schedules:[
                    {id:9001, name:'1íšŒì°¨(05-10 10:00)'},
                    {id:9002, name:'2íšŒì°¨(05-24 14:00)'}
                ]},
            {id:456, title:'ë¦¬ë”ì‹­ ì›Œí¬ìˆ', deptName:'í•™ìƒì²˜', period:'2025-06-10 ~ 2025-06-30',
                schedules:[{id:9101, name:'1íšŒì°¨(06-15 10:00)'}]},
        ],
        kpi: (progId, schdId)=>({
            apply: 80, attend: 65, complete: 60, survey: 58, rating: 4.5, mileage: 6000
        }),
        form: (prog)=>({
            title: prog?.title || '', dept: prog?.deptName || '', period: prog?.period || '',
            runPlace:'ì˜¤í”„ë¼ì¸ / ê³µí•™ê´€ 101í˜¸', contact:'010-1234-5678 / ops@univ.ac.kr',
            overview:'í”„ë¡œê·¸ë¨ ëª©ì ê³¼ ì£¼ìš” í™œë™ì„ ìš”ì•½í•©ë‹ˆë‹¤.',
            resultSummary:'ì´ 65ëª… ì°¸ì„, 60ëª… ì´ìˆ˜. ì¡°ë³„ í™œë™ê³¼ ë°œí‘œ ì§„í–‰.',
            satisfaction:'í‰ê·  4.5/5, ê¸/ë¶€ì • í”¼ë“œë°± ìš”ì•½.',
            competency:'ì˜ì‚¬ì†Œí†µ/ë¬¸ì œí•´ê²° ì—­ëŸ‰ê³¼ ë§¤í•‘.',
            issues:'ì¥ë¹„ ì„¸íŒ… ì§€ì—° ë°œìƒ, ì˜ˆë¹„ ì¥ë¹„ í•„ìš”.',
            improve:'ì‚¬ì „ ë¦¬í—ˆì„¤ ê°•í™”, ì§ˆë¬¸ì‹œê°„ í™•ë³´.'
        })
    };

    /* ===== Utilities ===== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toast(msg, type='ok', ms=2200){
        const box = document.createElement('div');
        box.className = `toast ${type}`; box.textContent = msg;
        $('#toastWrap').appendChild(box);
        setTimeout(()=>{ box.remove(); }, ms);
    }
    function fmtNumber(n){return Number(n||0).toLocaleString('ko-KR');}

    /* ===== Program Finder Modal ===== */
    const modalProg = $('#modalProg');
    $('#btnFindProg').addEventListener('click', ()=> { openProgModal(); });
    $('#btnCloseProg').addEventListener('click', ()=> modalProg.classList.remove('open'));
    $('#btnProgSearch').addEventListener('click', ()=> renderProgTable($('#progQuery').value.trim()));

    function openProgModal(){
        renderProgTable('');
        modalProg.classList.add('open');
    }
    function renderProgTable(q){
        const tbody = $('#progTable'); tbody.innerHTML='';
        const rows = DUMMY.programs.filter(p=>!q || p.title.includes(q));
        rows.forEach(p=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.deptName}</td>
      <td>${p.period}</td>
      <td><button class="btn pri" data-pid="${p.id}">ì„ íƒ</button></td>`;
            tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button').forEach(b=>{
            b.addEventListener('click', (e)=>{
                const pid = Number(e.currentTarget.dataset.pid);
                const prog = DUMMY.programs.find(x=>x.id===pid);
                state.programId = pid;
                $('#prog').value = `${prog.id} - ${prog.title}`;
                // íšŒì°¨ select ì±„ìš°ê¸°
                const sel = $('#schd'); sel.innerHTML='<option value="">íšŒì°¨ ì„ íƒ</option>';
                prog.schedules.forEach(s=>{
                    const opt = document.createElement('option'); opt.value=s.id; opt.textContent=s.name; sel.appendChild(opt);
                });
                modalProg.classList.remove('open');
                toast('í”„ë¡œê·¸ë¨ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        });
    }

    /* ===== Search / Load KPI & Form ===== */
    $('#btnSearch').addEventListener('click', async ()=>{
        const pTxt = $('#prog').value.trim();
        if(!state.programId){
            // ìˆ«ì ID ì§ì ‘ ì…ë ¥ í—ˆìš©
            const idFromText = /^\d+$/.test(pTxt) ? Number(pTxt) : null;
            if(idFromText) state.programId = idFromText;
        }
        state.scheduleId = $('#schd').value || null;

        if(!state.programId){ toast('í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”.', 'warn'); return; }

        // Load KPI (dummy)
        const k = DUMMY.kpi(state.programId, state.scheduleId);
        $('#kpiApply').textContent=fmtNumber(k.apply);
        $('#kpiAttend').textContent=fmtNumber(k.attend);
        $('#kpiComplete').textContent=fmtNumber(k.complete);
        $('#kpiSurvey').textContent=fmtNumber(k.survey);
        $('#kpiRating').textContent=k.rating?.toFixed(1);
        $('#kpiMileage').textContent=fmtNumber(k.mileage);

        // Fill stats table
        $('#stApply').value=k.apply; $('#stAttend').value=k.attend; $('#stComplete').value=k.complete;
        $('#stFail').value=Math.max(0,k.attend - k.complete);

        // Load form (dummy)
        const prog = DUMMY.programs.find(x=>x.id===state.programId);
        const f = DUMMY.form(prog);
        $('#title').value=f.title; $('#dept').value=f.dept; $('#period').value=f.period;
        $('#runPlace').value=f.runPlace; $('#contact').value=f.contact;
        $('#overview').value=f.overview; $('#resultSummary').value=f.resultSummary;
        $('#satisfaction').value=f.satisfaction; $('#competency').value=f.competency;
        $('#issues').value=f.issues; $('#improve').value=f.improve;

        toast('ê²€ìƒ‰ ì™„ë£Œ: KPI ë° ê¸°ë³¸ì •ë³´ê°€ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    });
    $('#btnReset').addEventListener('click', ()=>{
        $$('input, select, textarea').forEach(el=>{
            if(['btn','button','file'].includes(el.type)) return;
            if(el.id==='status') el.value='';
            else if(el.tagName==='SELECT') el.selectedIndex=0;
            else el.value='';
        });
        $('#thumbs').innerHTML=''; $('#docList').innerHTML='';
        state.programId=null; state.scheduleId=null; state.reportId=null; state.docs=[]; state.images=[];
        $$('#kpiApply,#kpiAttend,#kpiComplete,#kpiSurvey,#kpiRating,#kpiMileage').forEach(n=>n.textContent='-');
        toast('ì´ˆê¸°í™” ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    /* ===== Budget ===== */
    function addBudgetRow(item={name:'', amt:0, memo:''}){
        const tr=document.createElement('tr');
        tr.innerHTML=`
    <td><input type="text" class="bd-name" value="${item.name||''}"></td>
    <td><input type="number" class="bd-amt" value="${item.amt||0}"></td>
    <td><input type="text" class="bd-memo" value="${item.memo||''}"></td>
    <td><button class="btn err btn-del">ì‚­ì œ</button></td>`;
        $('#budgetTbody').appendChild(tr);
        tr.querySelector('.btn-del').addEventListener('click', ()=>{ tr.remove(); calcBudget(); });
        tr.querySelector('.bd-amt').addEventListener('input', calcBudget);
        calcBudget();
    }
    function calcBudget(){
        const sum = $$('#budgetTbody .bd-amt').reduce((a,el)=>a + Number(el.value||0), 0);
        $('#budgetSum').textContent = fmtNumber(sum);
    }
    $('#btnAddBudget').addEventListener('click', ()=> addBudgetRow());

    /* ===== Files: Docs ===== */
    $('#btnDocPick').addEventListener('click', ()=> $('#docInput').click());
    $('#docInput').addEventListener('change', e=> handleDocs(e.target.files));
    $('#docDrop').addEventListener('dragover', e=>{e.preventDefault();});
    $('#docDrop').addEventListener('drop', e=>{e.preventDefault(); handleDocs(e.dataTransfer.files);});
    function handleDocs(files){
        const ul = $('#docList');
        [...files].forEach(f=>{
            if(state.docs.length>=10){ toast('ë¬¸ì„œëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.','warn'); return; }
            state.docs.push({name:f.name,size:f.size,file:f});
            const li = document.createElement('li');
            li.textContent = `â€¢ ${f.name} (${fmtNumber(f.size)} bytes)`;
            ul.appendChild(li);
        });
    }

    /* ===== Files: Images ===== */
    $('#btnImgPick').addEventListener('click', ()=> $('#imgInput').click());
    $('#imgInput').addEventListener('change', e=> handleImages(e.target.files));
    $('#imgDrop').addEventListener('dragover', e=>{e.preventDefault();});
    $('#imgDrop').addEventListener('drop', e=>{e.preventDefault(); handleImages(e.dataTransfer.files);});
    function handleImages(files){
        const wrap = $('#thumbs');
        [...files].forEach(f=>{
            if(state.images.length>=12){ toast('ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 12ì¥ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.','warn'); return; }
            const url = URL.createObjectURL(f);
            state.images.push({url,file:f});
            const box = document.createElement('div');
            box.className='thumb';
            box.innerHTML=`<img src="${url}" alt="ì²¨ë¶€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"/><button title="ì‚­ì œ">âœ•</button>`;
            box.querySelector('button').addEventListener('click', ()=>{
                URL.revokeObjectURL(url); box.remove();
                state.images = state.images.filter(x=>x.url!==url);
            });
            wrap.appendChild(box);
        });
    }

    /* ===== Preview ===== */
    const modalPreview = $('#modalPreview');
    $('#btnPreview').addEventListener('click', ()=>{
        const html = `
    <div style="font-size:15px;line-height:1.6">
      <h3 style="margin:0 0 8px">[${$('#title').value||'-'}] ê²°ê³¼ë³´ê³ ì„œ</h3>
      <p class="muted">${$('#period').value||'-'} / ${$('#dept').value||'-'} / ${$('#runPlace').value||'-'}</p>
      <hr/>
      <h4>í™œë™ ê°œìš”</h4><p>${nl2br($('#overview').value)}</p>
      <h4>ìš´ì˜ ê²°ê³¼</h4><p>${nl2br($('#resultSummary').value)}</p>
      <h4>ë§Œì¡±ë„ ìš”ì•½</h4><p>${nl2br($('#satisfaction').value)}</p>
      <h4>ì„±ê³¼Â·ì—­ëŸ‰ ë§¤í•‘</h4><p>${nl2br($('#competency').value)}</p>
      <h4>íŠ¹ì´ì‚¬í•­</h4><p>${nl2br($('#issues').value)}</p>
      <h4>í–¥í›„ ê°œì„ </h4><p>${nl2br($('#improve').value)}</p>
      <h4>ì°¸ê°€/ì´ìˆ˜ í†µê³„</h4>
      <ul>
        <li>ì‹ ì²­ ${$('#stApply').value}ëª…, ì°¸ì„ ${$('#stAttend').value}ëª…, ì´ìˆ˜ ${$('#stComplete').value}ëª…, ë¯¸ì´ìˆ˜ ${$('#stFail').value}ëª…</li>
      </ul>
      <h4>ì˜ˆì‚° í•©ê³„</h4><p>${$('#budgetSum').textContent} ì›</p>
    </div>`;
        $('#previewBody').innerHTML = html;
        modalPreview.classList.add('open');
    });
    $('#btnClosePreview').addEventListener('click', ()=> modalPreview.classList.remove('open'));
    function nl2br(t){return (t||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replace(/\n/g,'<br>')}

    /* ===== Save / Submit / Delete / Export ===== */
    function collectPayload(){
        return {
            programId: state.programId,
            scheduleId: state.scheduleId,
            title: $('#title').value, dept: $('#dept').value, period: $('#period').value,
            runPlace: $('#runPlace').value, contact: $('#contact').value,
            body: {
                overview: $('#overview').value,
                resultSummary: $('#resultSummary').value,
                satisfaction: $('#satisfaction').value,
                competency: $('#competency').value,
                issues: $('#issues').value,
                improve: $('#improve').value
            },
            stats: {
                apply: Number($('#stApply').value||0),
                attend: Number($('#stAttend').value||0),
                complete: Number($('#stComplete').value||0),
                fail: Number($('#stFail').value||0)
            },
            budget: $$('#budgetTbody tr').map(tr=>({
                name: tr.querySelector('.bd-name').value,
                amt: Number(tr.querySelector('.bd-amt').value||0),
                memo: tr.querySelector('.bd-memo').value
            }))
        };
    }
    async function fakePost(url, payload){
        // ë°ëª¨ìš©: ì„±ê³µ ì‘ë‹µ ëª¨í‚¹
        await new Promise(r=>setTimeout(r, 350));
        return {ok:true, json: async()=>({reportId: state.reportId || 7001})};
    }
    $('#btnSave').addEventListener('click', async ()=>{
        if(!state.programId){ toast('í”„ë¡œê·¸ë¨ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.','warn'); return; }
        const res = await fakePost(API.save, collectPayload());
        if(res.ok){ const data = await res.json(); state.reportId = data.reportId; toast('ì„ì‹œì €ì¥ ì™„ë£Œ'); }
        else toast('ì €ì¥ ì‹¤íŒ¨','err');
    });
    $('#btnSubmit').addEventListener('click', async ()=>{
        if(!state.programId){ toast('í”„ë¡œê·¸ë¨ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.','warn'); return; }
        const res = await fakePost(API.submit, {...collectPayload(), reportId: state.reportId});
        if(res.ok){ toast('ì œì¶œ(ìŠ¹ì¸ìš”ì²­) ë˜ì—ˆìŠµë‹ˆë‹¤.'); } else toast('ì œì¶œ ì‹¤íŒ¨','err');
    });
    $('#btnDelete').addEventListener('click', ()=>{
        if(!confirm('ë³´ê³ ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        // ë°ëª¨: ìƒíƒœë§Œ ì´ˆê¸°í™”
        state.reportId=null; toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
    $('#btnExport').addEventListener('click', ()=>{
        if(!state.programId){ toast('í”„ë¡œê·¸ë¨ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.','warn'); return; }
        // ì‹¤ì œì—ì„  location.href = API.export(...)
        toast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
    });

    /* ===== Init ===== */
    function init(){
        // ì˜ˆì‹œ ì˜ˆì‚° í–‰ 1ê°œ
        addBudgetRow({name:'ë‹¤ê³¼', amt:50000, memo:'ë¬¼/ê°„ì‹'});
        addBudgetRow({name:'ê°•ì‚¬ë£Œ', amt:200000, memo:'2ì‹œê°„'});
    }
    init();
</script>
</body>
</html>
