<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 정보 수정 - 마이페이지 (통합본)</title>

    <!-- Bootstrap 5 CSS 로드 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 아이콘 로드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Bootstrap Bundle JS (드롭다운, 모달, Offcanvas 기능 포함) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 사용자 요청에 따른 개별 스타일 로드 (절대 수정 금지) -->
    <link rel="stylesheet" th:href="@{/css/mypage/user-info-edit.css}" />

    <!-- 통합된 CSS 스타일 (user-info-edit.css 내용) -->
    <style>
        /* ===== 마이페이지 레이아웃 공통 스타일 추가 (반응형 사이드바) ===== */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .sidebar {
            /* md 이상에서 보일 때 너비와 높이 설정 */
            min-height: 100vh;
        }
        .sidebar .transition {
            /* 부드러운 호버 효과를 위한 트랜지션 */
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar .hover-bg-light:hover {
            background-color: #f8f9fa; /* Bootstrap light color */
        }
        .sidebar .active {
            /* 활성화된 메뉴 항목 스타일 */
            background-color: var(--bs-primary-bg-subtle, #cfe2ff); /* Bootstrap primary light color */
            font-weight: 600;
        }

        /* Offcanvas (모바일 햄버거 메뉴) 스타일 */
        .offcanvas-start {
            /* 모바일에서 왼쪽에서 나타나도록 */
            width: 250px;
        }
        .offcanvas-body .active {
            /* 모바일 메뉴에서도 활성화 스타일 적용 */
            background-color: var(--bs-primary-bg-subtle, #cfe2ff);
            font-weight: 600;
        }
        .offcanvas-body .hover-bg-light:hover {
            background-color: #f8f9fa;
        }

        /* 메인 콘텐츠 상단 패딩 조정 (Fixed-top Navbar 때문에) */
        .main-content {
            /* 모바일에서는 fixed-top navbar가 있으므로 상단에 공간을 줌 */
            padding-top: 70px !important;
            flex-grow: 1; /* body flex-direction: column; 에 맞춰서 메인 컨텐츠 영역 확장 */
        }

        @media (min-width: 768px) { /* md 이상 */
            .main-content {
                /* md 이상에서는 fixed-top navbar가 없으므로 기존 패딩 사용 */
                padding-top: 3rem !important; /* p-md-5에 맞춰 3rem */
            }
        }


        /* ===== 기존 사용자 정보 폼 스타일 유지 ===== */
        .user-info-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-control:disabled, .form-control[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }

        /* 푸터 링크 호버 효과 추가 (footer.html 내용) */
        footer a:hover {
            color: #ccc !important;
            text-decoration: underline !important;
        }
    </style>
</head>
<body>

<!-- ============================================== -->
<!-- 통합된 HEADER (header.html 내용) -->
<!-- ============================================== -->
<header class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
        <!-- 로고/웹사이트명 -->
        <a class="navbar-brand d-flex align-items-center" href="/">
            <img src="https://placehold.co/30x30/2196f3/ffffff?text=SCMS"
                 alt="scms 로고"
                 class="me-2"
                 style="height: 30px;">
            <span class="fw-bold">푸름대학교 학생역량관리시스템</span>
        </a>

        <!-- 햄버거 토글 버튼 (모바일) -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- 네비게이션 메뉴 -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">홈</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/assessment">역량진단</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/counselinguser/student">상담</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/user/noncurricular/programs">비교과 프로그램</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/mypage">마이페이지</a>
                </li>

                <!-- 로그인/로그아웃 버튼 (모킹) -->
                <li class="nav-item ms-lg-3">
                    <a class="btn btn-outline-light" href="/login">로그인</a>
                </li>
            </ul>
        </div>
    </div>
</header>


<!-- ============================================== -->
<!-- 통합된 MAIN CONTENT (user-info-edit.html 내용) -->
<!-- ============================================== -->
<div class="container-fluid">
    <div class="row">

        <!-- 사이드바 (md 이상) -->
        <div class="col-md-3 col-lg-2 bg-light d-none d-md-block sidebar p-0 shadow-sm">
            <div class="p-4 pt-5 sticky-top">
                <h5 class="fw-bold mb-4">마이페이지</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <a href="/mypage/dashboard" class="d-block p-2 text-decoration-none text-dark rounded transition hover-bg-light">
                            <i class="fas fa-chart-line me-2"></i> 대시보드
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="/mypage/user-info" class="d-block p-2 text-decoration-none text-dark rounded transition active">
                            <i class="fas fa-user-edit me-2"></i> 사용자 정보 수정
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="/mypage/counseling-status" class="d-block p-2 text-decoration-none text-dark rounded transition hover-bg-light">
                            <i class="fas fa-calendar-check me-2"></i> 상담 예약 현황
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="/mypage/program-history" class="d-block p-2 text-decoration-none text-dark rounded transition hover-bg-light">
                            <i class="fas fa-clipboard-list me-2"></i> 비교과 프로그램 이력
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 모바일용 햄버거 메뉴 버튼 -->
        <button class="btn btn-primary d-md-none fixed-top m-3 shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar" style="width: auto;">
            <i class="fas fa-bars me-1"></i> 메뉴
        </button>

        <!-- 모바일용 Offcanvas 사이드바 -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header bg-dark text-white">
                <h5 class="offcanvas-title fw-bold" id="offcanvasSidebarLabel">마이페이지 메뉴</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0">
                <ul class="list-unstyled">
                    <li>
                        <a href="/mypage/dashboard" class="d-block p-3 text-decoration-none text-dark border-bottom hover-bg-light">
                            <i class="fas fa-chart-line me-2"></i> 대시보드
                        </a>
                    </li>
                    <li>
                        <a href="/mypage/user-info" class="d-block p-3 text-decoration-none text-dark border-bottom active">
                            <i class="fas fa-user-edit me-2"></i> 사용자 정보 수정
                        </a>
                    </li>
                    <li>
                        <a href="/mypage/counseling-status" class="d-block p-3 text-decoration-none text-dark border-bottom hover-bg-light">
                            <i class="fas fa-calendar-check me-2"></i> 상담 예약 현황
                        </a>
                    </li>
                    <li>
                        <a href="/mypage/program-history" class="d-block p-3 text-decoration-none text-dark border-bottom hover-bg-light">
                            <i class="fas fa-clipboard-list me-2"></i> 비교과 프로그램 이력
                        </a>
                    </li>
                </ul>
            </div>
        </div>


        <!-- 메인 콘텐츠 영역 -->
        <main class="col-md-9 col-lg-10 ms-sm-auto px-md-4 main-content">
            <div class="pb-3 border-bottom d-flex justify-content-between align-items-center">
                <h2 class="h3 fw-bold">사용자 정보 수정</h2>
            </div>

            <!-- 사용자 정보 수정 폼 -->
            <div class="user-info-container shadow">
                <form id="userInfoForm">
                    <div class="form-group">
                        <label for="name" class="form-label">이름</label>
                        <input type="text" class="form-control" id="name" value="이름" disabled>
                    </div>

                    <div class="form-group">
                        <label for="studentId" class="form-label">학번</label>
                        <input type="text" class="form-control" id="studentId" value="학번" disabled>
                    </div>

                    <div class="form-group">
                        <label for="major" class="form-label">학과</label>
                        <input type="text" class="form-control" id="major" value="학과" disabled>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">이메일 *</label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="error-message" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="phone" class="form-label">휴대폰 번호 *</label>
                        <input type="tel" class="form-control" id="phone" placeholder="010-XXXX-XXXX" pattern="[0-9]{3}-[0-9]{3,4}-[0-9]{4}" required>
                        <div class="error-message" id="phone-error"></div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-secondary me-md-2" id="cancelBtn"><i class="fas fa-times me-1"></i> 취소</button>
                        <button type="submit" class="btn btn-primary" id="updateBtn"><i class="fas fa-save me-1"></i> 저장</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<!-- Custom Modal for Confirmation -->
<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="customConfirmModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>확인 필요</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="customConfirmModalBody">
                <!-- 메시지는 JS에서 삽입됨 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button>
                <button type="button" class="btn btn-warning" id="customConfirmYesBtn">예</button>
            </div>
        </div>
    </div>
</div>


<!-- ============================================== -->
<!-- 통합된 FOOTER (footer.html 내용) -->
<!-- ============================================== -->
<footer class="mt-auto bg-dark text-white py-5">
    <div class="container">
        <div class="row">
            <!-- 역량 진단 -->
            <div class="col-md-4 mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-chalkboard-teacher me-2"></i>역량진단
                </h5>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/assessment/user/assessment" class="text-decoration-none text-light">진단 결과 확인하기</a></li>
                </ul>
            </div>

            <!-- 상담 예약 -->
            <div class="col-md-4 mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>상담예약
                </h5>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/counseling/user/student" class="text-decoration-none text-light">상담 예약하기</a></li>
                    <li class="mb-2"><a href="/counseling/user/counseling/status" class="text-decoration-none text-light">내 예약 조회</a></li>
                </ul>
            </div>

            <!-- 비교과 프로그램 -->
            <div class="col-md-4 mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-book me-2"></i>비교과 프로그램
                </h5>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/user/noncurricular" class="text-decoration-none text-light">교내 비교과 프로그램</a></li>
                    <li class="mb-2"><a href="/user/noncurricular" class="text-decoration-none text-light">교외 비교과 프로그램</a></li>
                </ul>
            </div>
        </div>

        <!-- 하단 저작권 -->
        <div class="border-top pt-3 mt-3 text-center">
            <p class="mb-0 text-muted small">&copy; 2024 푸름대학교 학생역량관리센터. All rights reserved.</p>
        </div>
    </div>
</footer>


<!-- ============================================== -->
<!-- 통합된 JAVASCRIPT (user-info-edit.js 내용 및 Mockup) -->
<!-- ============================================== -->
<script>
    // ===========================================
    // Mocking for Standalone Execution
    // 실제 환경에서는 외부 JS 파일에서 로드됨
    // ===========================================
    const CONFIG = {
        API: {
            ENDPOINTS: {
                USER_INFO: "/api/user/info"
            },
            MOCK_DATA: {
                name: "김철수",
                studentId: "20230001",
                major: "컴퓨터공학과",
                email: "kim.cs@purum.ac.kr",
                phone: "010-1234-5678"
            }
        },
        MESSAGES: {
            SUCCESS: {
                USER_UPDATE: "사용자 정보가 성공적으로 업데이트되었습니다."
            },
            CONFIRM: {
                CANCEL_EDIT: "수정된 내용이 있습니다. 정말 취소하시겠습니까? (저장되지 않은 변경 사항은 손실됩니다.)"
            }
        }
    };

    // Custom alert/error handler
    const ErrorHandler = {
        showError: (error) => {
            console.error("Error (Mock):", error);
            alert("오류 발생: " + (error.message || "알 수 없는 오류가 발생했습니다."));
        },
        showSuccess: (message) => {
            console.log("Success (Mock):", message);
            alert("성공: " + message);
        }
    };

    // Mock API utility
    const ApiUtils = {
        request: async (url, options) => {
            console.log(`Mock API Request to ${url}`, options);
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay

            if (url === CONFIG.API.ENDPOINTS.USER_INFO) {
                if (options.method === 'PATCH') {
                    // Simulate successful update and update mock data
                    const data = JSON.parse(options.body);
                    CONFIG.API.MOCK_DATA.email = data.email;
                    CONFIG.API.MOCK_DATA.phone = data.phone;
                    return { success: true, message: "Update successful" };
                }
                // Simulate GET request (for loadUserInfo)
                return CONFIG.API.MOCK_DATA;
            }
            throw new Error("Invalid Mock API Endpoint");
        }
    };

    // ===========================================
    // user-info-edit.js 내용 시작
    // ===========================================
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('userInfoForm');
        const updateBtn = document.getElementById('updateBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Custom Modal elements (Bootstrap 5 JS Bundle이 로드되어 있어야 함)
        const confirmModalElement = document.getElementById('customConfirmModal');
        if (!confirmModalElement) {
            console.error("Error: Custom modal element not found.");
            return;
        }
        // Bootstrap 모달 인스턴스 생성
        const confirmModal = new bootstrap.Modal(confirmModalElement);
        const confirmModalBody = document.getElementById('customConfirmModalBody');
        const confirmYesBtn = document.getElementById('customConfirmYesBtn');

        let originalData = {};

        /**
         * 초기 사용자 정보를 로드하고 폼에 채우는 함수
         */
        async function loadUserInfo() {
            try {
                const data = await ApiUtils.request(CONFIG.API.ENDPOINTS.USER_INFO, { method: 'GET' });

                document.getElementById('name').value = data.name || '';
                document.getElementById('studentId').value = data.studentId || '';
                document.getElementById('major').value = data.major || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('phone').value = data.phone || '';

                // 초기 데이터를 저장하여 변경 여부를 확인하는 데 사용
                originalData = {
                    email: data.email,
                    phone: data.phone
                };

            } catch (error) {
                if (typeof ErrorHandler !== 'undefined') {
                    ErrorHandler.showError(error);
                } else {
                    console.error("사용자 정보 로드 오류:", error);
                }
            }
        }

        /**
         * 현재 폼 데이터가 초기 데이터와 다른지 확인하는 함수
         * @returns {boolean} 데이터가 변경되었으면 true
         */
        function isDataChanged() {
            const currentData = {
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim()
            };

            return currentData.email !== originalData.email || currentData.phone !== originalData.phone;
        }

        /**
         * 폼 유효성 검사 함수
         * @returns {boolean} 유효성 검사 통과 여부
         */
        function validateForm() {
            clearErrors();
            let isValid = true;

            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');

            // 1. 이메일 유효성 검사 (간단한 형식 체크)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value.trim())) {
                document.getElementById('email-error').textContent = '유효한 이메일 주소를 입력해주세요.';
                isValid = false;
            }

            // 2. 전화번호 유효성 검사 (XX-XXX(X)-XXXX 형식)
            const phoneRegex = /^[0-9]{3}-[0-9]{3,4}-[0-9]{4}$/;
            if (!phoneRegex.test(phoneInput.value.trim())) {
                document.getElementById('phone-error').textContent = '유효한 휴대폰 번호(010-XXXX-XXXX)를 입력해주세요.';
                isValid = false;
            }

            return isValid;
        }

        /**
         * 사용자 정보를 업데이트하는 함수
         */
        async function updateUserInfo() {
            if (!validateForm()) {
                return;
            }

            if (!isDataChanged()) {
                if (typeof ErrorHandler !== 'undefined') {
                    ErrorHandler.showSuccess("변경 사항이 없습니다.");
                } else {
                    console.log("변경 사항 없음");
                }
                return;
            }

            const formData = {
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };

            try {
                // 외부 JS 파일에 정의된 ApiUtils를 사용한다고 가정
                const response = await ApiUtils.request(CONFIG.API.ENDPOINTS.USER_INFO, {
                    method: 'PATCH',
                    body: JSON.stringify(formData)
                });

                // 성공 메시지 표시 및 데이터 다시 로드
                if (typeof ErrorHandler !== 'undefined') {
                    ErrorHandler.showSuccess(CONFIG.MESSAGES.SUCCESS.USER_UPDATE);
                } else {
                    console.log("정보가 성공적으로 업데이트되었습니다.");
                }
                loadUserInfo(); // 성공 후 데이터 다시 로드
            } catch (error) {
                // 외부 JS 파일에 정의된 ErrorHandler를 사용한다고 가정
                if (typeof ErrorHandler !== 'undefined') {
                    ErrorHandler.showError(error);
                } else {
                    console.error("사용자 정보 업데이트 오류:", error);
                }
            }
        }

        /**
         * 폼의 에러 메시지를 지우는 함수
         */
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(element => {
                element.textContent = '';
            });
        }


        // 폼 로드 (초기 데이터 불러오기)
        loadUserInfo();

        // 폼 제출 이벤트 리스너
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            updateUserInfo();
        });

        // '취소' 버튼 클릭 시 Custom Modal 호출
        cancelBtn.addEventListener('click', function() {
            if (isDataChanged()) {
                // 변경 사항이 있을 경우 확인 모달 팝업
                confirmModalBody.textContent = CONFIG.MESSAGES.CONFIRM.CANCEL_EDIT;
                confirmYesBtn.onclick = () => {
                    confirmModal.hide();
                    loadUserInfo(); // 변경 사항 취소 (초기 데이터 재로드)
                    clearErrors();
                };
                confirmModal.show();
            } else {
                // 변경 사항이 없으면 바로 취소 처리 (대시보드로 이동한다고 가정)
                console.log("변경 사항 없음. 취소 처리.");
                window.location.href = "/mypage/dashboard"; // Mock navigation
            }
        });

    });
</script>
</body>
</html>