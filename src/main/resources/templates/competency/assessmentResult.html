<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(
                    title='진단 결과',
                    content=~{::main},
                    css=~{::#page-css},
                    scripts=~{::#page-scripts}
                  )}">

<th:block th:fragment="css" id="page-css">
    <link th:href="@{/css/competency/assessment-result.css}" rel="stylesheet">
</th:block>

<main th:fragment="content" class="container-lg my-5">
    <div class="assessment-result-container">
        <div class="result-header">
            <h2 class="main-title" th:text="${assessmentResultData.assessmentTitle}">2025년 역량진단 결과</h2>
            <p class="sub-title">
                <span th:text="${assessmentResultData.userName}">홍길동</span> 님의 진단 결과입니다.
                (진단 완료일: <span th:text="${#temporals.format(assessmentResultData.submittedAt, 'yyyy.MM.dd')}">2025.03.14</span>)
            </p>
        </div>

        <div class="result-card mb-4">
            <h5 class="card-title">1. 전체 요약</h5>
            <div class="chart-container">
                <div id="tui-radar-chart"></div>
            </div>
        </div>

        <div class="result-card mb-4">
            <h5 class="card-title">2. 상세 점수 분석</h5>
            <div class="detail-scores-container">
                <div class="parent-competency-group" th:each="parentResult : ${assessmentResultData.scoreDetails}">

                    <h6 class="parent-title">
                        [핵심역량]
                        <span th:text="${parentResult.name}">통합적 사고</span>
                        (평균 점수: <span th:text="${#numbers.formatDecimal(parentResult.parentAverageScore, 1, 2)}">4.5</span>점)
                    </h6>

                    <div class="child-competency-list">
                        <div class="child-score-item" th:each="child : ${parentResult.children}">
                            <span class="child-name" th:text="${child.name}">분석적 사고</span>
                            <div class="score-bar-container">
                                <div class="score-bar"
                                     th:style="'width: ' + (${child.score} / 5 * 100) + '%;'">
                                </div>
                            </div>
                            <span class="child-score" th:text="${#numbers.formatDecimal(child.score, 1, 2)} + '점'">xx점</span>
                        </div>
                    </div>

                </div> </div>
        </div>

        <div class="result-card">
            <h5 class="card-title">3. 종합 피드백</h5>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="feedback-box strength">
                        <h6 class="feedback-title">강점 (Top 2)</h6>
                        <ul class="feedback-list">
                            <li th:each="item : ${assessmentResultData.strengths}">
                                <strong th:text="${item.competencyName}">분석적 사고</strong>:
                                <span th:text="${item.advice}">예) 분석적 사고 잘함</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="feedback-box weakness">
                        <h6 class="feedback-title">성장 제안 (Bottom 2)</h6>
                        <ul class="feedback-list">
                            <li th:each="item : ${assessmentResultData.weaknesses}">
                                <strong th:text="${item.competencyName}">협업 능력</strong>
<!--                                (<span th:text="${#numbers.formatDecimal(item.score, 1, 2)} + '점'">0점</span>)-->
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="advice-section" th:if="${!#lists.isEmpty(assessmentResultData.weaknesses)}">
                <h6 class="advice-title">성장을 위한 맞춤 조언</h6>
                <p>
                    <strong th:text="'\'\'' + ${assessmentResultData.weaknesses[0].competencyName} + '\' 역량 향상을 위한 Tip!'">
                        역량 향상을 위한 Tip!
                    </strong>
                </p>
                <p class="advice-content" th:text="${assessmentResultData.weaknesses[0].advice}">
                    해당 역량을 키우기 위해 관련 비교과 프로그램에 참여해보세요
                </p>
            </div>

        </div> </div>
</main>

<th:block th:fragment="scripts" id="page-scripts">
    <script src="https://uicdn.toast.com/chart/latest/toastui-chart.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // 1. Controller에서 넘겨준 DTO 내부의 radarChartData를 가져옵니다.
        // (RadarChartData: { labels: [...], scores: [...] })
        const serverChartData = /*[[${assessmentResultData.radarChartData}]]*/ null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!serverChartData) return;

            const el = document.getElementById('tui-radar-chart');

            const fixedWidth = el.offsetWidth;

            // 2. 데이터 설정
            const data = {
                categories: serverChartData.labels,
                series: [
                    {
                        name: '나의 점수',
                        data: serverChartData.scores
                    }
                ]
            };

            // 3. 옵션 설정
            const options = {
                chart: {
                    width: fixedWidth,    // 부모 div 너비에 맞춤
                    height: 450       // ✅ 높이를 고정해서 "지랄맞은" 리사이징 방지
                },
                legend: { align: 'bottom' },
                series: {
                    showDot: true,
                    showArea: true
                },
                plot: { type: 'radar' },
                yAxis: {
                    scale: { min: 0, max: 5 }, // 5점 만점 고정
                    min: 0, max: 5, stepSize: 1
                },
                // ✅ [추가] 소수점 깔끔하게 자르기 (툴팁)
                tooltip: {
                    formatter: (value) => Number(value).toFixed(1) + '점'
                },
                // (선택) 차트 내보내기 메뉴 숨김
                exportMenu: { visible: false }
            };

            // 4. 차트 그리기
            // Toast UI Chart 버전에 따라 함수명이 다를 수 있어 안전하게 처리
            if (toastui.Chart.radarChart) {
                toastui.Chart.radarChart({ el, data, options });
            } else {
                // 구버전 호환
                new toastui.Chart.radarChart({ el, data, options });
            }
        });

        /*]]>*/
    </script>
</th:block>
</html>